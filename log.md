# virusclass_nextflow logfile

## 2022-08-18
`To get BOWTIE2 process to run for every output tuple from FASTP, it was cruical to add the index as channel.value, to get the combinatorics!`

`bowtie`: The log file does not work with 2> .log... WHY?

#### Download kaiju virus db:
```bash
wget https://kaiju.binf.ku.dk/database/kaiju_db_viruses_2022-03-29.tgz
tar zxvf kaiju_db_viruses_2022-03-29.tgz 
```

The kaiju process works but produces a non file... Maybe because it is also from the stdout channel? 

Everything is nonefile!! WHY???
**SOLUTION TO ABOVE PROBLEM**
I had the argument cleanup = true in the .config file, which deletes content of work file. Since I had NOT put the publishDir mode as copy, the final results were just a symlink to the deleted work directory!. 

## 2022-08-19 
* Think I need to run kaiju against bigger database, containing both bacteria and viruses. 
`download the refseq database from kaijus server`
```bash
wget https://kaiju.binf.ku.dk/database/kaiju_db_refseq_2022-03-23.tgz
tar zxvf kaiju_db_refseq_2022-03-23.tgz
```

In `krona2table`the -u flag exists, which: *Unclassified reads are not counted for the total reads when calculating percentages for classified reads.*
Include or not include this? 

The KAIJU2TABLE module results in the error:
`unknown recognition error type: groovyjarjarantlr4.v4.runtime.LexerNoViableAltException` and complains that it does not have an input file. 

Trying to run in outside Nextflow:
```bash
kaiju2table -t /home/viller/virusclass/databases/kaiju_db/refseq/nodes.dmp -n /home/viller/virusclass/databases/kaiju_db/refseq/names.dmp -r genus -e -o kaiju_summary.tsv Dol1_S19_L001.kaiju.out
```
The above command works! Why does it not work inside nextflow main.nf?

**NOW the KAIJU2TABLE works, without me changing anything...** WEIRD!! 

* Download standard kraken database from https://benlangmead.github.io/aws-indexes/k2
```bash 
wget https://genome-idx.s3.amazonaws.com/kraken/k2_standard_20220607.tar.gz
```

Trying kraken2 command outside nextflow:
```bash
kraken2 \
    --db /home/viller/virusclass/databases/kraken/standard/ \
    --report testar.kraken2.report.tsv \
    --use-mpa-style \
    --use-names \
    --paired \
    /home/viller/virusclass/results/fastp/reads/Dol1_S19_L001_filt_R1.fastq.gz \
    /home/viller/virusclass/results/fastp/reads/Dol1_S19_L001_filt_R2.fastq.gz

# must unzip the krakendb tar first


```
Above command works! 

**Having problems with the megahit module. It will not save the file where it needs to go, so fiddeling around a little bit there. Otherwise it seems to work.**
FINALLY IT WORKS!
Had to do this: 
```bash
megahit \
    -1 ${reads[0]} \
    -2 ${reads[1]} \
    --out-dir megahit \
    --out-prefix ${sample_id}
    
    mv megahit/${sample_id}.contigs.fa ${sample_id}.contigs.fa
```

Added config_length.py to extract the length of the contigs generated by megahit. 
### **NB!** Had to put the .py script in the bin/ and put `#!/usr/bin/env python` in the python script!!!

**Will PROBABLY skip BUSCO, QUAST, prokka and prodigal.**
Will continue with CAT and gtdb and then... --> Phylogeny tree with mash!

### To install metabat2:
```bash
mamba install -c bioconda/label/cf201901 metabat2

```
Runned metabat2, with error:
```bash
Command error:
  [Error!] can't open input file Dol1_S19_L001_bins.table.tsv
  [Error!] There are no lines in the abundance depth file or fasta file!
```
**The bam file is generated like: align the raw reads to the assembled contigs** 
*"First we need to map the reads back against the assembly to get coverage information"*



Tutorial for binning here: https://www.youtube.com/watch?v=q9U0uTFRsl4&ab_channel=BioinformaticsVirtualCoordinationNetwork
*https://github.com/edgraham/BinSanity/wiki/Usage*
-- https://www.hadriengourle.com/tutorials/meta_assembly/

* Wrote python script for renaming fasta files to have headers like: contig_1, contig_2 etc...


### METABAT2 requires contigs > 2kb to be accurate. This is usually done by assembly of reads from many different samples from the same site. 

create CONTIGS2INDEX:
* map the reads back against the assembly to get coverage information 


## 2022-08-22 Monday

* Continue with bowtie2 alignment 
* samtools module
    * sam to bam
    * index and sort 
    
 
Which files should align to the new index of assembled contigs? The "unaligned" reads from the first bowtie2 step, or the files from FASTP? 
`Right now it aligned the host-read-filtered fastq files to the contigs index.`

**Need to output the folder name of the CONTIGS2INDEX process, not the files in it.** 
Error now:
```bash
Error executing process > 'BOWTIE2_ALIGN2CONTIGS (1)'

Caused by:  Process `BOWTIE2_ALIGN2CONTIGS (1)` terminated with an error exit status (255)Command executed:
  bowtie2     -x [Dol1_S19_L001, [/home/viller/virusclass/virusclassification_nextflow/work/71/a25811cb79674320e38718cd843fed/Dol1_S19_L001.1.bt2, /home/viller/virusclass/virusclassification_nextflow/work/71/a25811cb79674320e38718cd843fed/Dol1_S19_L001.2.bt2, /home/viller/virusclass/virusclassification_nextflow/work/71/a25811cb79674320e38718cd843fed/Dol1_S19_L001.3.bt2, /home/viller/virusclass/virusclassification_nextflow/work/71/a25811cb79674320e38718cd843fed/Dol1_S19_L001.4.bt2, /home/viller/virusclass/virusclassification_nextflow/work/71/a25811cb79674320e38718cd843fed/Dol1_S19_L001.rev.1.bt2, /home/viller/virusclass/virusclassification_nextflow/work/71/a25811cb79674320e38718cd843fed/Dol1_S19_L001.rev.2.bt2]]     -1 Dol1_S19_L001_unaligned.1.fastq     -2 Dol1_S19_L001_unaligned.2.fastq     -S Dol1_S19_L001_aligned.sam     2> Dol1_S19_L001.bowtie.log

Command exit status:
  255
```
The output from `CONTIGS2INDEX` **CANNOT** be a tuple! 
Change from
```
output:
    tuple val(sample_id), path('*.bt2'), emit: index
    
# to:
output:
    val(sample_id), emit: sample_id
    path('*.bt2'), emit: index
```

Trying to use the operator: **getParent** to get the folder of the contig index. 
Documentation: https://buildmedia.readthedocs.org/media/pdf/nextflow1/latest/nextflow1.pdf


changing from:
```
path('*.bt2'), emit: index
# to
path('${sample_id}'), emit: index
```
The above did not work, it must be: `path('*.bt2'), emit: index`. Therefore I need to get the parentfolder with operators like: operator: **getParent** 
in the main.nf script. 


Trying many different things related to all of the above, but it in the end it was hard to get it to work. The solution below, however, worked:
```nextflow
process TESTAR {  
    echo true

    input:
    tuple val(sample_id), path(reads)
    
    
    script:
    index = params.bowtie2_align2contigs.toString() + '/' + sample_id
    """
    echo ${index}
   
    """   
}
```

In CONTIS2INDEX:
```bash
# instead of:
output:
    val(sample_id), emit: sample_id
    val('*.bt2'), emit: index
# change to:
```

Testing bowtie2 from command line:
```bash
bowtie2 -x /home/viller/virusclass/databases/bowtie2/Dol1_S19_L001/Dol1_S19_L001 -1 /home/viller/virusclass/results/bowtie2/unaligned/Dol1_S19_L001_unaligned.1.fastq -2 /home/viller/virusclass/results/bowtie2/unaligned/Dol1_S19_L001_unaligned.2.fastq -S TESTARBOWTIE_aligned.sam
```
The above works...

### Now the ALIGN2CONTIGS works
Had to publishdir the new index of the contigs to a absolute path and use: 
`index = params.bowtie2_contigs_index.toString() + '/' + sample_id + '/' + sample_id`
To get it to work. 

install samtools:
```bash
mamba install samtools==1.11
```

**YES!!** Finally fixed the bowtieALIGN2CONTIGS problem (that it could not find the index). Fixed it with this line:
```bash
index = index_files[0].toRealPath().toString().split('\\.')[0]
```

Trying metabat2 command:
```bash
  metabat2 \
    -i /home/viller/virusclass/results/megahit/Dol1_S19_L001.contigs.fa \
    /home/viller/virusclass/results/bowtie2/align2contigs/aligned/Dol1_S19_L001.bam \
    --minContig 1500 \
    -o binTEST 
```
Two short contigs (<1500) in the above command, resulted in no bins.

#### Downloading new test data
```bash
curl -O -J -L https://osf.io/h9x6e/download
```

Trying workflow with new testdata:
```bash
Error executing process > 'METABAT2 (1)'

Caused by:
  Missing output file(s) `*_bins*` expected by process `METABAT2 (1)`

Command executed:

  metabat2     -i ERR321578.contigs.fa     ERR321574.bam     -o ERR321578_bins

Command exit status:
  0

Command output:
  MetaBAT 2 (v2.12.1) using minContig 2500, minCV 1.0, minCVSum 1.0, maxP 95%, minS 60, and maxEdges 200. 
  0 bins (0 bases in total) formed.

Work dir:
  /home/viller/virusclass/virusclassification_nextflow/work/12/82d8fb6e82474bd5d5210d452f8713
Tip: you can try to figure out what's wrong by changing to the process work dir and showing the script file named `.command.sh`
```
Must fix so that if the output is null due to to small contigs, the output is nothing! 

```bash
 kaiju \
    -t /home/viller/virusclass/databases/kaiju_db/refseq/nodes.dmp \
    -f /home/viller/virusclass/databases/kaiju_db/refseq/kaiju_db_refseq.fmi \
    -i /home/viller/virusclass/testdata/ERR1135369_1.fastq \
    -j /home/viller/virusclass/testdata/ERR1135369_2.fastq \
    -o TESTAR.kaiju.out
```
`Error: Read names are not identical between the two input files. Probably reads are not in the same order in both files.`

### Sorting fastq files
Hmm... This error replicates although I use the **raw** files.
Is there some way to sort the fastq files???
Trying the package `pip install pyfastx`

**Seems like the reads does NOT pair up between the two files**
Trying new data:
```bash
wget http://downloads.hmpdacc.org/data/Illumina/anterior_nares/SRS018585.tar.bz2
```

Solved the problems that metabat2 sometimes does not output anything:
output: `optional: true`

## 2022-08-23

Installing metaspades:
```bash
mamba install -c bioconda spades
```

testing metaspades:
```bash
metaspades.py \
    -1 /home/viller/virusclass/testdata/test_1.fastq \
    -2 /home/viller/virusclass/testdata/test_2.fastq \
    -o test_spades 
```
Spades was much longer to run compared to megahit, and resulted in much longer contigs


Install Maxbin2:
```bash
mamba install -c bioconda maxbin2
```

**Changing the main.nf to include metaspades instead of megahit and running metabat2 on that instead**
It seems like metabat doesnt produce anything, although the contigs are longer from metaspades than from megahit. 

Will try with maxbin2. 
**I do not get it to work** 

* Run kaiju on the contig files 

### 2022-08-24

Runned the whole pipeline on large test data, and it WORKED, but was slow:
```bash
Completed at: 24-Aug-2022 00:59:33
Duration    : 8h 15m 23s
CPU hours   : 16.6
Succeeded   : 21
```

Need to increase the CPU, threads and RAM. 

* Add CAT/BAT today as well. 
* ADd human index for bowtie2

**Maybe change the metabat2 parameters** 
From 1500 to... 2500? 

#### Chaning the nextflow.config file to add cpus and so on:
* https://carpentries-incubator.github.io/workflows-nextflow/08-configuration/index.html

```bash
process {
    cpus = 2
    memory = 8.GB
    time = '1 hour'
    publishDir = [ path: params.outdir, mode: 'copy' ]
}

#or

process {
    withName: FASTQC {
        cpus = 2
        memory = { 2.GB * task.cpus }
        publishDir = { "fastqc/$sample" }
    }
}

# ti add 
```

**Installing CAT/BAT**
```bash
mamba install -c bioconda cat
```

Moving the CAT and bowtie2 human index to databases in this project. Takes a lot of time unpacking CAT... 
**DONE**. 

